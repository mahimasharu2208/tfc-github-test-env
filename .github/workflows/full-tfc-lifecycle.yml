name: 'TFC Full Lifecycle (Plan & Apply)'

on:
  push:
    branches:
      - main
    paths:
      - '**.tf'

env:
  TFC_ORG_NAME: mahima-test
  TFC_WORKSPACE_NAME: tfc-github-test-env
  TFC_WORKSPACE_ID: ws-De4GT4vxchbYmT2M

jobs:
  plan_and_apply:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        
      # --- 1. Create Configuration Version & Upload Code ---
      - name: ðŸ“¦ Create and Upload Config Version
        id: create_config_version
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
        run: |
          echo "Creating Configuration Version for workspace ID: ${{ env.TFC_WORKSPACE_ID }}"
          
          # 1a. Request a new Configuration Version and get the upload URL
          CV_DATA=$(curl -s -X POST \
            --header "Authorization: Bearer $TFC_TOKEN" \
            --header "Content-Type: application/vnd.api+json" \
            --data '{"data": {"type": "configuration-versions", "attributes": {"auto-queue-runs": false}, "relationships": {"workspace": {"data": {"type": "workspaces", "id": "${{ env.TFC_WORKSPACE_ID }}"}}}}}' \
            https://app.terraform.io/api/v2/configuration-versions)
            
          CV_ID=$(echo $CV_DATA | jq -r '.data.id')
          UPLOAD_URL=$(echo $CV_DATA | jq -r '.data.attributes."upload-url"')

          echo "CV_ID=$CV_ID" >> $GITHUB_ENV
          
          # 1b. Create ZIP and Upload
          zip -r terraform_config.zip . -i '*.tf' '*.tfvars'
          curl -s -X PUT -H "Content-Type: application/octet-stream" \
            --data-binary @terraform_config.zip \
            "$UPLOAD_URL"

      # --- 2. Create TFC Run with the new Configuration Version ---
      - name: ðŸš€ Create TFC Run
        id: create_run
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
        run: |
          PAYLOAD='{"data": {"attributes": {"message": "GA Run for commit ${{ github.sha }}", "is-destroy": false}, "relationships": {"workspace": {"data": {"type": "workspaces", "id": "${{ env.TFC_WORKSPACE_ID }}"}}, "configuration-version": {"data": {"type": "configuration-versions", "id": "${{ env.CV_ID }}"}}}, "type": "runs"}}'
          
          RUN_DATA=$(curl -s -X POST \
            --header "Authorization: Bearer $TFC_TOKEN" \
            --header "Content-Type: application/vnd.api+json" \
            --data "$PAYLOAD" \
            https://app.terraform.io/api/v2/runs)
          
          RUN_ID=$(echo $RUN_DATA | jq -r '.data.id')
          echo "TFC_RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Run ID: $RUN_ID"
          
      # --- 3. Wait for the Plan to Finish ---
      - name: â³ Wait for Plan to Complete
        uses: benc-uk/wait-for-status-action@v3 # Use v3 or later
        with:
          url: https://app.terraform.io/api/v2/runs/${{ env.TFC_RUN_ID }}
          status-key: data.attributes.status
          desired-status: planned_and_saved 
          wait-interval: 10
          timeout: 600

      # --- 4. Retrieve and Display PLAN Summary (Detailed Output) ---
      - name: ðŸ“‹ Get and Display PLAN Summary
        id: plan_summary_display
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
          TFC_RUN_ID: ${{ env.TFC_RUN_ID }}
        run: |
          # 4a. Get Run Details and Extract Plan ID
          RUN_DATA=$(curl -s --header "Authorization: Bearer $TFC_TOKEN" https://app.terraform.io/api/v2/runs/$TFC_RUN_ID)
          PLAN_ID=$(echo "$RUN_DATA" | jq -r '.data.relationships.plan.data.id')
          
          # 4b. Get Plan Details and Extract Attributes
          PLAN_ATTRIBUTES=$(curl -s --header "Authorization: Bearer $TFC_TOKEN" https://app.terraform.io/api/v2/plans/$PLAN_ID | jq -r '.data.attributes')

          # 4c. Output to Action Log and Step Summary
          echo "--- Plan Details ---"
          echo "Run ID: $TFC_RUN_ID"
          echo "Run Type: Speculative Plan"
          echo "Run Detail Endpoint: https://app.terraform.io/api/v2/runs/$TFC_RUN_ID"
          echo "== PLAN =="
          echo "Plan Detail Endpoint: https://app.terraform.io/api/v2/plans/$PLAN_ID"
          echo "Result:"
          
          # Use jq to structure the output for the log
          echo "$PLAN_ATTRIBUTES" | jq '{
              "resource-additions": ."resource-additions",
              "resource-changes": ."resource-changes",
              "resource-destructions": ."resource-destructions",
              "resource-imports": ."resource-imports"
          }'
          
          # Optional: Add to GitHub Job Summary for quick view
          echo "## â˜ï¸ Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "* **âž• Additions:** $(echo "$PLAN_ATTRIBUTES" | jq -r '."resource-additions"')" >> $GITHUB_STEP_SUMMARY
          echo "* **âž– Destructions:** $(echo "$PLAN_ATTRIBUTES" | jq -r '."resource-destructions"')" >> $GITHUB_STEP_SUMMARY

      # --- 5. Confirm and Apply the TFC Run ---
      - name: âœ… Confirm and Apply Run
        id: apply_run
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
          TFC_RUN_ID: ${{ env.TFC_RUN_ID }}
        run: |
          echo "Sending confirmation for apply to Run ID: $TFC_RUN_ID"
          curl -s -X POST \
            --header "Authorization: Bearer $TFC_TOKEN" \
            --header "Content-Type: application/vnd.api+json" \
            --data '{"comment": "Applied via GitHub Action"}' \
            https://app.terraform.io/api/v2/runs/$TFC_RUN_ID/actions/apply
      
      # --- 6. Wait for the Apply to Finish ---
      - name: â³ Wait for Apply to Complete
        uses: benc-uk/wait-for-status-action@v3 # Use v3 or later
        with:
          url: https://app.terraform.io/api/v2/runs/${{ env.TFC_RUN_ID }}
          status-key: data.attributes.status
          desired-status: applied
          wait-interval: 15
          timeout: 1200

      # --- 7. Retrieve and Display APPLY Summary (Detailed Output) ---
      - name: ðŸ“Š Get and Display APPLY Summary
        id: apply_summary_display
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
          TFC_RUN_ID: ${{ env.TFC_RUN_ID }}
        run: |
          # 7a. Get Run Details and Extract Apply ID
          RUN_DATA=$(curl -s --header "Authorization: Bearer $TFC_TOKEN" https://app.terraform.io/api/v2/runs/$TFC_RUN_ID)
          APPLY_ID=$(echo "$RUN_DATA" | jq -r '.data.relationships.apply.data.id')

          # 7b. Get Apply Details and Extract Attributes
          APPLY_ATTRIBUTES=$(curl -s --header "Authorization: Bearer $TFC_TOKEN" https://app.terraform.io/api/v2/applies/$APPLY_ID | jq -r '.data.attributes')

          # 7c. Output to Action Log
          echo "--- Apply Details ---"
          echo "Run ID: $TFC_RUN_ID"
          echo "Run Type: Provisional Apply"
          echo "Run Detail Endpoint: https://app.terraform.io/api/v2/runs/$TFC_RUN_ID"
          echo "== APPLY =="
          echo "Plan Detail Endpoint: https://app.terraform.io/api/v2/applies/$APPLY_ID" # Note: TFC uses 'Plan Detail Endpoint' in its log structure even for apply, but the API endpoint is /applies/
          echo "Result:"
          
          # Use jq to structure the output for the log, matching your desired format
          echo "$APPLY_ATTRIBUTES" | jq '{
              "resource-additions": ."resource-additions",
              "resource-changes": ."resource-changes",
              "resource-destructions": ."resource-destructions",
              "resource-imports": ."resource-imports"
          }'
          
          # Optional: Add final results to GitHub Job Summary
          echo "## âœ… Terraform Apply Results" >> $GITHUB_STEP_SUMMARY
          echo "* **âž• Added:** $(echo "$APPLY_ATTRIBUTES" | jq -r '."resource-additions"')" >> $GITHUB_STEP_SUMMARY
          echo "* **âž– Destroyed:** $(echo "$APPLY_ATTRIBUTES" | jq -r '."resource-destructions"')" >> $GITHUB_STEP_SUMMARY
